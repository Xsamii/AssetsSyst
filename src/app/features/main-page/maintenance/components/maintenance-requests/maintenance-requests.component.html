<!-- ============================= -->
<!-- BREAD CRUMB -->
<!-- ============================= -->
<app-bread-crumb [title]="'طلبات الصيانة'" [imageTitle]="'./assets/icons/maintenanceRequestsActive.svg'" [subTitles]="[
    { name: 'الرئيسية', routerLink: '/' },
    { name: 'إدارة الأصول', routerLink: '/buildings' },
    { name: 'طلبات الصيانة', routerLink: '/buildings/maintenace-requests' }
  ]" [isFilte]="true" [inputPlaceholder]="'ابحث بالرقم، اسم المبنى، المبنى، العطل الرئيسي...'"
  [buttonText]="(userRole === 1 || userRole === 2 || userRole === 6) ? 'طلب جديد' : ''" [saveBtnText]="'إضافة'"
  [isShowAddEdite]="false" [isShowFilter]="showBreadcrumb ? false : true" (onFilterClick)="onShowFilterPopup()"
  (valueSearch)="filterBySearchText($event)" (addButton)="routeToAddPage()"></app-bread-crumb>

<!--
[isShowFilter]="showBreadcrumb ? false : true"
 (addButton)="openAdd()"
  (valueSearch)="filterBySearchTesxt($event)"
-->
<!-- ============================= -->
<!-- TABLE LIST-->
<!-- ============================= -->
<app-list [cols]="cols" [isSearching]="isSearchingReasult" [values]="values" [totalPageCount]="totalPageCount"
  [withControles]="true" [evaluate]="true" [isShowMaintenaceRequest]="userRole ==userTypes.Admin? true : false"
  [isAssetManageMentEmployeesMaintenaceRequest]="userRole ==userTypes.ServiceRequester || userRole ==userTypes.MaintenanceSupervisor? true : false"
  [IsExecutiveMaintenanceRequests]="(userRole ==userTypes.ProjectManager|| userRole ==userTypes.OfficeManager) && userOfficeType== officeTypes.Executive"
  [IsEmployeeMaintenaceRequestForProcess]="(userRole ==userTypes.OfficeEmployee) && userOfficeType== officeTypes.Executive"
  [IsEmployeeMaintenaceRequestForReview]="(userRole ==userTypes.OfficeEmployee) && userOfficeType== officeTypes.Supervisor"
  [IsSupervisoryMaintenanceRequests]="(userRole ==userTypes.ProjectManager|| userRole ==userTypes.OfficeManager) && userOfficeType== officeTypes.Supervisor"
  (rowsCountChanged)="getAllMaintenanceRequest($event)" [noData]="showBreadcrumb ? false : true"
  (showRequest)="showRequest($event)" (editEvent)="openEdit($event)" (recieveRequest)="recieveRequest($event)"
  (reviewRequest)="reviewRequest($event)" (addRequestNotes)="addRequestNotes($event)"
  (customizePreview)="customizePreview($event)" (statusPreview)="statusPreview($event)"
  (confirmStatusPreview)="confirmStatusPreview($event)" (deleteEvent)="deleteMaintenanceRequest($event)"
  (CustomizeProcessing)="CustomizeProcessing($event)" (maintenanceToPart)="maintenanceToPart($event)"
  (evaluateEvent)="evaluateEvent($event)"></app-list>

<!-- ============================= -->
<!-- POPUP FILTER-->
<!-- ============================= -->

<div class="overlay" *ngIf="showFilterPopup" (click)="hideFilterPopup()">
  <div class="popup" (click)="$event.stopPropagation()">
    <div class="title">
      <img src="./assets/icons/search-filter.svg" />
      <p>تصفية طلبات الصيانة</p>
      <i class="fa-solid fa-xmark cursor-pointer mr-auto" (click)="hideFilterPopup()"></i>
    </div>
    <!--  (ngSubmit)="OnSubmitData()" -->

    <form [formGroup]="filterForm">
      <!-- ---------------------------------------------------------------- -->
      <!-- ------------------TWO INPUTS FIELDS----------------------------- -->
      <!-- ---------------------------------------------------------------- -->
      <div class="two-inputs-fields">
        <div class="input-field">
          <label for="main-building"> الموقع </label>
          <div class="field-icon">
            <img src="./assets/icons/select-main-building-icon.svg" />

            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              placeholder="اختر الموقع" formControlName="siteId" [options]="sitesLookup"
              (onChange)="onSiteChange($event.value)" [filter]="true" [filterBy]="'name'"></p-dropdown>
          </div>
        </div>
        <div class="input-field">
          <label for="main-building"> المبنى </label>
          <div class="field-icon">
            <img src="./assets/icons/select-main-building-icon.svg" />

            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              placeholder="اختر  المبنى" formControlName="buildingId" [options]="builldingLookup"
              (onChange)="getAllBuildingSubUnit(filterForm.value.buildingId)" [filter]="true"
              [filterBy]="'name'"></p-dropdown>
          </div>
        </div>
      </div>

      <div class="two-inputs-fields">
        <!-- <div class="input-field">
          <label for="main-building"> المبنى </label>
          <div class="field-icon">
            <img src="./assets/icons/select-main-building-icon.svg" />

            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              placeholder="اختر  المبنى" formControlName="subUnitId" [options]="buildingSubUnitLookup" [filter]="true"
              [filterBy]="'name'" ></p-dropdown>
          </div>
        </div> -->

        <div class="input-field">
          <label for="main-building"> أولوية الطلب </label>
          <div class="field-icon">
            <img src="./assets/icons/info-icon.svg" />

            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              formControlName="requestPriorety" placeholder="اختر  أولوية الطلب  " [options]="requestPrioretyLookup"
              [filter]="true" [filterBy]="'name'"></p-dropdown>
          </div>
        </div>

        <div class="input-field">
          <label for="main-building"> نوع العطل الرئيسي </label>
          <div class="field-icon">
            <img src="./assets/icons/types-icon-fill.svg" />
            <!-- -------------------------------- -->
            <!-- -------------------------------- -->
            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              formControlName="mainCategoryType" placeholder="اختر  نوع العطل الرئيسي "
              [options]="primaryMaintenanceTypeLookup"
              (onChange)="getMaintTypesByParent(filterForm.value.mainCategoryType)" [filter]="true"
              [filterBy]="'name'"></p-dropdown>
            <!-- -------------------------------- -->
            <!-- -------------------------------- -->
          </div>
        </div>

      </div>
      <!-- ---------------------------------------------------------------- -->
      <!-- ------------------TWO INPUTS FIELDS----------------------------- -->
      <!-- ---------------------------------------------------------------- -->
      <div class="two-inputs-fields">

        <div class="input-field">
          <label for="main-building"> نوع العطل الفرعي </label>
          <div class="field-icon">
            <img src="./assets/icons/types-icon-fill.svg" />
            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              formControlName="subCategoryType" placeholder="اختر  نوع العطل الفرعي "
              [options]="secondaryMaintenanceTypeLookup" [filter]="true" [filterBy]="'name'"></p-dropdown>
          </div>
        </div>

        <div class="input-field">
          <label for="main-building"> حالة الطلب </label>
          <div class="field-icon">
            <img src="./assets/icons/info-icon.svg" />
            <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
              formControlName="maintenanceRequestStatusId" placeholder="اختر  حالة الطلب  "
              [options]="visitRequestsStatusLookup" [filter]="true" [filterBy]="'name'"></p-dropdown>
          </div>
        </div>

      </div>
      <!-- ---------------------------------------------------------------- -->
      <!-- ------------------TWO INPUTS FIELDS----------------------------- -->
      <!-- ---------------------------------------------------------------- -->



      <!-- =======================BUTTONS================== -->
      <div class="buttons-content">
        <button class="buttons" type="button" (click)="popupFilter()">
          تصفية
        </button>
        <button class="buttons-white" type="button" (click)="closePopupFilter()">
          إعادة ضبط
        </button>
      </div>
    </form>
  </div>
</div>


<!-- ============================= -->
<!-- EVALUATION POPUP -->
<!-- ============================= -->
<div class="overlay" *ngIf="showEvaluationDialog">
  <div class="popup evaluation-popup">
    <div class="text-center mb-6">
      <h3 class="text-xl font-semibold text-teal-600">تقييم العقد</h3>
    </div>

    <!-- Loading state -->
    <div *ngIf="isLoadingEvaluation" class="text-center py-8">
      <p class="text-gray-500">جاري تحميل معايير التقييم...</p>
    </div>

    <!-- Evaluation Criteria -->
    <div class="space-y-2" *ngIf="evaluationTerms.length > 0 && !isLoadingEvaluation">

      <!-- Headers -->
      <div class="grid grid-cols-2 gap-4 pb-4 border-b border-gray-200">
        <div class="text-right">
          <h4 class="text-lg font-medium text-gray-700">البند</h4>
        </div>
        <div class="text-center">
          <h4 class="text-lg font-medium text-gray-700">التقييم</h4>
        </div>

      </div>

      <!-- Loop through evaluation terms -->
      <div *ngFor="let term of evaluationTerms; let i = index" class="grid grid-cols-2 gap-4 items-center ">

        <!-- Term Name (Right Column) -->
        <div class="text-right">
          <h5 class="text-base font-medium text-gray-800 leading-relaxed">{{ term.name }}</h5>
        </div>
        <!-- Stars (Left Column) -->
        <div class="text-center">
          <div class="flex justify-center gap-1">
            <i *ngFor="let star of [1,2,3,4,5]" class="fas text-3xl cursor-pointer transition-colors duration-200"
              [ngClass]="getRating(i) >= star ? 'fa-star text-yellow-400' : 'fa-star text-gray-300'"
              (click)="setRatingAndSave(i, star)" (mouseenter)="setHoverRating(i, star)"
              (mouseleave)="clearHoverRating(i)"></i>
          </div>
        </div>



      </div>

    </div>

    <!-- No evaluation terms message -->
    <div *ngIf="evaluationTerms.length === 0 && !isLoadingEvaluation" class="text-center py-8">
      <p class="text-gray-500">لا توجد معايير تقييم متاحة لهذا العقد</p>
    </div>

    <!-- Buttons -->
    <div class="flex justify-center mt-8">
      <button
        class="px-12 py-3 bg-white border-2 border-teal-500 text-teal-600 rounded-lg hover:bg-teal-50 transition-colors font-medium"
        type="button" (click)="closeEvaluationDialog()">
        إغلاق
      </button>
    </div>

  </div>
</div>


<!-- ======================================================== -->
<!-- NO DATA -->
<!-- ======================================================== -->
<app-no-data-yet *ngIf="values.length == 0 && !isSearchingReasult" [noDataElements]="{
  noDataImg: './assets/images/no-data-search.png',
  noDataText: [1,2,6].includes(userRole) ? 'يبدو أنك لم تقم بإضافة أي طلب صيانة  بعد، ستظهر طلبات الصيانة المضافة  هنا... يمكنك البدء بإضافة أول طلب صيانة' :'لا يوجد أي عقود صيانة مضافة ستظهر عقود الصيانة المضافة هنا...',
  noDataButtonText: [1,2,6].includes(userRole) ?  'طلب صيانة جديد' : '',
  }" (addNewEvent)="routeToAddPage()"></app-no-data-yet>

<!-- ============================= -->
<!-- SWEET ALERTS-->
<!-- ============================= -->
<!-- Success -->
<app-sweet-alert-message *ngIf="alertSuccess" [data]="{
    type: 'success',
    text: alertSuccessMsg,
    buttonText: 'عرض طلبات الصيانة'
  }" (confirmMessage)="alertSuccessFun($event)"></app-sweet-alert-message>
<!-- error -->
<app-sweet-alert-message *ngIf="alertError" [data]="{
    type: 'error',
    text: alertErrorMsg
      ? alertErrorMsg
      : 'يبدو أنه قد حدث خطأ ما، من فضلك أعد المحاولة مجددًا',
    buttonText: ''
  }" (confirmMessage)="alertErrorFun($event)"></app-sweet-alert-message>
<!-- CONFIRM -->
<app-sweet-alert-message *ngIf="alertConfirm" [data]="{
    type: 'confirm',
    text: 'هل أنت متأكد أنك تريد حذف الطلب؟ سيتم حذفه نهائيًا من قائمة طلبات الصيانة',
    buttonText: ''
  }" (confirmMessage)="alertConfirmFun($event)"></app-sweet-alert-message>

<!-- ============================== -->
<!-- EVENTS -->
<!-- ============================== -->
<!-- ======================================================== -->
<!-- Recieve Request-->
<!-- ======================================================== -->
<div class="recive-overlay" *ngIf="showReciveRequest">
  <div class="popup">
    <div class="img">
      <img src="./assets/icons/alert-success.svg" />
    </div>
    <p>هل أنت متأكد أنك تُريد تأكيد استلام الطلب؟</p>
    <div class="btns">
      <button class="recive" (click)="onRecieveRequest()">استلام</button>
      <button class="cancle" (click)="showReciveRequest = false">رجوع</button>
    </div>
  </div>
</div>
<!-- تخصيص معالجة  -->
<div class="notes-overlay" *ngIf="showCustomizeProcessing">
  <div class="popup">
    <h2>
      <img src="./assets/icons/usersActive.svg" />
      تخصيص معالجة
    </h2>
    <form [formGroup]="customizeForm" (ngSubmit)="onCustomizeProcessing()">
      <div class="input-field">
        <label> الموظف المخصص </label>
        <div class="field-icon">
          <img src="./assets/icons/userIcon.svg" />
          <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
            formControlName="assignedEmployeeId" placeholder="اختر الموظف المخصص"
            [options]="assignedEmployeeList"></p-dropdown>
        </div>
        <small *ngIf="
            customizeFormControl.assignedEmployeeId.invalid &&
            customizeFormControl.assignedEmployeeId.touched
          ">برجاء اختيار الموظف المختص
        </small>
      </div>
      <div class="input-field">
        <label>ملاحظات</label>
        <div class="input-icon">
          <img src="./assets/icons/notes-icon.svg" />
          <textarea formControlName="note" placeholder="أدخل ملاحظاتك إن وُجدت"></textarea>
        </div>
      </div>
      <div class="btns">
        <button class="recive" type="submit" [disabled]="customizeForm.invalid">
          إضافة
        </button>
        <button class="cancle" type="button" (click)="showCustomizeProcessing = false">
          إلغاء
        </button>
      </div>
    </form>
  </div>
</div>



<!-- ======================================================== -->
<!-- Add Request Notes-->
<!-- ======================================================== -->
<div class="notes-overlay" *ngIf="showAddRequestNotes">
  <div class="popup">
    <h2>
      <img src="./assets/icons/notes-active.svg" />
      إضافة ملاحظة للطلب
    </h2>
    <form [formGroup]="notesForm" (ngSubmit)="onAddRequestNotes()">
      <div class="input-field">
        <label>ملاحظات</label>
        <div class="input-icon">
          <img src="./assets/icons/notes-icon.svg" />
          <textarea formControlName="consultantNotes" placeholder="أدخل ملاحظتك عن الطلب"></textarea>
        </div>
        <small *ngIf="
            notesFormControll.consultantNotes.invalid &&
            notesFormControll.consultantNotes.touched
          ">برجاء ادخال الملاحظات</small>
      </div>
      <div class="btns">
        <button class="recive" type="submit" [disabled]="notesForm.invalid">
          إضافة
        </button>
        <button class="cancle" type="button" (click)="showAddRequestNotes = false">
          إلغاء
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ======================================================== -->
<!-- Customize Preview-->
<!-- ======================================================== -->
<div class="notes-overlay" *ngIf="showCustomizePreview">
  <div class="popup">
    <h2>
      <img src="./assets/icons/usersActive.svg" />
      تخصيص معاينة
    </h2>
    <form [formGroup]="customizeForm" (ngSubmit)="onCustomizePreview()">
      <div class="input-field">
        <label> الموظف المخصص </label>
        <div class="field-icon">
          <img src="./assets/icons/userIcon.svg" />
          <p-dropdown class="w-full" [styleClass]="'w-full bg-filterBtnBg'" optionLabel="name" optionValue="id"
            formControlName="assignedEmployeeId" placeholder="اختر الموظف المخصص"
            [options]="assignedEmployeeList"></p-dropdown>
        </div>
        <small *ngIf="
            customizeFormControl.assignedEmployeeId.invalid &&
            customizeFormControl.assignedEmployeeId.touched
          ">برجاء اختيار الموظف المختص
        </small>
      </div>
      <div class="input-field">
        <label>ملاحظات</label>
        <div class="input-icon">
          <img src="./assets/icons/notes-icon.svg" />
          <textarea formControlName="note" placeholder="أدخل ملاحظاتك إن وُجدت"></textarea>
        </div>
      </div>
      <div class="btns">
        <button class="recive" type="submit" [disabled]="customizeForm.invalid">
          إضافة
        </button>
        <button class="cancle" type="button" (click)="showCustomizePreview = false">
          إلغاء
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ======================================================== -->
<!-- Add Request Preview-->
<!-- ======================================================== -->
<div class="add-request-preview-overlay" *ngIf="showPreviewRequest">
  <div class="popup">
    <h2>
      <img src="./assets/icons/maintenanceRequestsActive.svg" />
      إضافة طلب معاينة
    </h2>
    <form [formGroup]="reviewRequestForm" (ngSubmit)="onReviewRequest()">
      <div class="two-inputs">
        <div class="input-field">
          <label> تاريخ المعاينة </label>
          <div class="field-icon">
            <img src="./assets/icons/calender.svg" />

            <p-calendar class="mt-2 bg-gray-100 rounded-lg outline-none w-full" formControlName="reviewDate"
              [placeholder]="' اختر تاريخ المعاينة '" [styleClass]="'w-full h-12 '" [inputStyleClass]="'bg-gray-100'"
              [showIcon]="false"></p-calendar>
          </div>
          <small *ngIf="
              reviewRequestFormControll.reviewDate.invalid &&
              reviewRequestFormControll.reviewDate.touched
            ">برجاء اختيار تاريخ المعاينة</small>
        </div>
        <!-- ---------- -->
        <div class="input-field">
          <label> وقت المعاينة </label>
          <div class="field-icon">
            <img src="./assets/icons/clock.svg" />

            <p-calendar dir="rtl" class="mt-2 bg-gray-100 rounded-lg outline-none w-full" formControlName="reviewTime"
              [placeholder]="' اختر وقت المعاينة '" [styleClass]="'w-full h-12 '" [inputStyleClass]="'bg-gray-100'"
              [showIcon]="false" [timeOnly]="true"></p-calendar>
          </div>
          <small *ngIf="
              reviewRequestFormControll.reviewTime.invalid &&
              reviewRequestFormControll.reviewTime.touched
            ">برجاء اختيار وقت المعاينة</small>
        </div>
      </div>

      <div class="input-field">
        <label>ملاحظات</label>
        <div class="input-icon">
          <img src="./assets/icons/notes-icon.svg" />
          <textarea formControlName="note" placeholder="أدخل ملاحظاتك إن وُجدت"></textarea>
        </div>
      </div>

      <!-- --------------------------------- -->
      <!-- --------------------------------- -->
      <div class="form-content">
        <div class="title">
          <p>مرفقات الطلب</p>
        </div>

        <div class="fileContainer flex flex-col col-span-3">
          <app-uploadFile [uploadedFiles]="uploadedFiles" [editMode]="editMode" [showTitle]="false"
            [currentId]="editeId" [routeName]="'maintenace-requests'"></app-uploadFile>
        </div>
      </div>
      <!-- --------------------------------- -->
      <!-- --------------------------------- -->
      <div class="btns">
        <button class="recive" type="submit" [disabled]="reviewRequestForm.invalid">
          إضافة
        </button>
        <button class="cancle" type="button" (click)="showPreviewRequest = false">
          إلغاء
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ======================================================== -->
<!-- Status Preview -->
<!-- ======================================================== -->
<div class="status-preview-overlay" *ngIf="showStatusPreview">
  <div class="popup">
    <h2>
      <img src="./assets/icons/flag.svg" />
      حالة المعاينة
    </h2>
    <form [formGroup]="statusPreviewForm" (ngSubmit)="onStatusPreview()">
      <div class="two-inputs">
        <div class="input-field">
          <label> حالة المعاينة </label>

          <div class="raido-button">
            <div>
              <input formControlName="isAccept" type="radio" id="accept" name="isAccept" [value]="true" />
              <label for="accept">قبول</label>
            </div>
            <div>
              <input formControlName="isAccept" type="radio" id="refuse" name="isAccept" [value]="false" />
              <label for="refuse">رفض</label>
            </div>
          </div>
        </div>
      </div>

      <div class="input-field">
        <label>ملاحظات</label>
        <div class="input-icon">
          <img src="./assets/icons/notes-icon.svg" />
          <textarea formControlName="note" placeholder="أدخل ملاحظاتك إن وُجدت"></textarea>
        </div>
      </div>

      <!-- --------------------------------- -->
      <!-- --------------------------------- -->
      <div class="form-content">
        <div class="title">
          <p>مرفقات الطلب</p>
        </div>

        <div class="fileContainer flex flex-col col-span-3">
          <app-uploadFile [uploadedFiles]="uploadedFiles" [editMode]="editMode" [showTitle]="false"
            [currentId]="editeId" [routeName]="'maintenace-requests'"></app-uploadFile>
        </div>
      </div>
      <!-- --------------------------------- -->
      <!-- --------------------------------- -->
      <div class="btns">
        <button class="recive" type="submit">
          {{
          statusPreviewFormControll.isAccept.value == true ? "قبول" : "رفض"
          }}
        </button>
        <button class="cancle" type="button" (click)="showStatusPreview = false">
          إلغاء
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ======================================================== -->
<!-- CONFIRM -->
<!-- ======================================================== -->

<!-- REFUSE -->
<div class="accept-overlay" *ngIf="showConfirmRefusePreview">
  <div class="popup">
    <div class="img">
      <img src="./assets/icons/alert-error.svg" />
    </div>
    <p>هل أنت متأكد أنك تُريد تأكيد رفض معالجة الطلب؟</p>
    <div class="btns">
      <button class="confirm" (click)="onConfirmStatusPreview(true)">
        تأكيد الرفض
      </button>
      <button class="close" (click)="onConfirmStatusPreview(false)">
        قبول المعالجة
      </button>
    </div>
  </div>
</div>
<!-- ACCEPT -->
<div class="accept-overlay" *ngIf="showConfirmAcceptPreview">
  <div class="popup">
    <div class="img">
      <img src="./assets/icons/alert-success.svg" />
    </div>
    <p>هل أنت متأكد أنك تُريد قبول المعالجة و إغلاق الطلب ؟</p>
    <div class="btns">
      <button class="close" (click)="onConfirmStatusPreview(true)">
        إغلاق الطلب
      </button>
      <button class="refuse" (click)="onConfirmStatusPreview(false)">
        رفض المعالجة
      </button>
    </div>
  </div>
</div>
