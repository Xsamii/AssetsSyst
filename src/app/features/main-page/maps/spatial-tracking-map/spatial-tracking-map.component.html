<!-- Spatial Tracking Map Dashboard -->
<div class="spatial-tracking-map-dashboard">
  <!-- Breadcrumb -->
  <app-bread-crumb
    class="bg-white"
    [title]="'المتابعة المكانية'"
    [imageTitle]="'./assets/icons/mainBuildingsActive.svg'"
    [subTitles]="[
      { name: 'الرئيسية', routerLink: '/' },
      { name: 'المتابعة المكانية', routerLink: '/map' }
    ]"
    [isFilte]="true"
    [isShowFilter]="false"
    [showInPutSearch]="false"
    (onFilterClick)="openFilterDialog()">
  </app-bread-crumb>

  <!-- Search Dialog -->
  <div class="overlay" *ngIf="showFilterDialog" (click)="closeFilterDialog()">
    <div class="popup" (click)="$event.stopPropagation()">
      <div class="title">
        <img src="./assets/icons/search-filter.svg" />
        <p>تصفية البيانات</p>
        <i class="fa-solid fa-xmark cursor-pointer mr-auto" (click)="closeFilterDialog()"></i>
      </div>
      <form [formGroup]="filterForm" (ngSubmit)="applyFiltersFromDialog()">
        <!-- Filter by Location Section -->
        <div class="filter-section">
          <div class="filter-section-title">تصفية حسب الموقع</div>
          <div class="grid grid-cols-12 gap-4">
            <!-- المجزرة -->
            <div class="input-field col-span-6">
              <label>المجزرة</label>
              <div class="dropdown-container">
                <p-dropdown
                  class="w-full"
                  [styleClass]="'w-full bg-filterBtnBg py-3'"
                  [style]="{
                    background: 'url(./assets/icons/select-main-building-icon.svg) no-repeat right 10px center',
                    'background-color': '#f6f6f6',
                    'padding-right': '35px'
                  }"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="اختر المجزرة"
                  formControlName="slaughterhouse"
                  [options]="slaughterhouseOptions"
                  [filter]="true"
                  [showClear]="false"
                  (onChange)="onSlaughterhouseChange()">
                </p-dropdown>
              </div>
            </div>

            <!-- المبنى -->
            <div class="input-field col-span-6">
              <label>المبنى</label>
              <div class="dropdown-container">
                <p-dropdown
                  class="w-full"
                  [styleClass]="'w-full bg-filterBtnBg py-3'"
                  [style]="{
                    background: 'url(./assets/icons/userIcon.svg) no-repeat right 10px center',
                    'background-color': '#f6f6f6',
                    'padding-right': '35px'
                  }"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="اختر المبنى"
                  formControlName="building"
                  [options]="buildingOptions"
                  [filter]="true"
                  [showClear]="false"
                  [disabled]="!filterForm.get('slaughterhouse')?.value"
                  (onChange)="onBuildingChange()">
                </p-dropdown>
              </div>
            </div>

            <!-- الدور -->
            <div class="input-field col-span-6">
              <label>الدور</label>
              <div class="dropdown-container">
                <p-dropdown
                  class="w-full"
                  [styleClass]="'w-full bg-filterBtnBg py-3'"
                  [style]="{
                    background: 'url(./assets/icons/userIcon.svg) no-repeat right 10px center',
                    'background-color': '#f6f6f6',
                    'padding-right': '35px'
                  }"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="اختر الدور"
                  formControlName="floor"
                  [options]="floorOptions"
                  [filter]="true"
                  [showClear]="false"
                  [disabled]="!filterForm.get('building')?.value"
                  (onChange)="onFloorChange()">
                </p-dropdown>
              </div>
            </div>

            <!-- الغرفة -->
            <div class="input-field col-span-6">
              <label>الغرفة</label>
              <div class="dropdown-container">
                <p-dropdown
                  class="w-full"
                  [styleClass]="'w-full bg-filterBtnBg py-3'"
                  [style]="{
                    background: 'url(./assets/icons/userIcon.svg) no-repeat right 10px center',
                    'background-color': '#f6f6f6',
                    'padding-right': '35px'
                  }"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="اختر الغرفة"
                  formControlName="room"
                  [options]="roomOptions"
                  [filter]="true"
                  [showClear]="false"
                  [disabled]="!filterForm.get('floor')?.value"
                  (onChange)="onRoomChange()">
                </p-dropdown>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter by System Section -->
        <div class="filter-section">
          <div class="filter-section-title">تصفية حسب النظام</div>
          <div class="grid grid-cols-12 gap-4">
            <!-- النظام -->
            <div class="input-field col-span-12">
              <label>النظام</label>
              <div class="dropdown-container">
                <p-dropdown
                  class="w-full"
                  [styleClass]="'w-full bg-filterBtnBg py-3'"
                  [style]="{
                    background: 'url(./assets/icons/userIcon.svg) no-repeat right 10px center',
                    'background-color': '#f6f6f6',
                    'padding-right': '35px'
                  }"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="اختر النظام"
                  formControlName="systemName"
                  [options]="systemNameOptions"
                  [filter]="true"
                  [showClear]="false"
                  (onChange)="onSystemNameChange()">
                </p-dropdown>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons-content mt-5">
          <button class="buttons" type="submit">تصفية</button>
          <button class="buttons-white" type="button" (click)="resetFilters()">إعادة ضبط</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-indicator" *ngIf="isLoading">
    <i class="fas fa-spinner fa-spin"></i>
    <span>جاري تحميل الخريطة...</span>
  </div>

  <!-- Map Container -->
  <div id="mapContainer" class="w-full bg-gray-200 rounded-lg relative flex-1" style="min-height: 0;">
    <!-- Map View -->
    <div #mapViewNode class="map-view w-full h-full"></div>

    <!-- Asset Number Search -->
    <div class="asset-search-container">
      <p-autoComplete
        [(ngModel)]="selectedAssetNumber"
        [suggestions]="assetNumberSuggestions"
        (completeMethod)="searchAssetNumber($event)"
        (onSelect)="onAssetNumberSelect($event)"
        (onClear)="onAssetNumberClear()"
        (ngModelChange)="onAssetNumberChange($event)"
        [minLength]="2"
        placeholder="ابحث برقم الأصل..."
        [inputStyleClass]="'asset-search-input'">
      </p-autoComplete>
    </div>

    <!-- Map Controls -->
    <app-map-controls
      (layerListToggle)="toggleLayerList()"
      (baseMapToggle)="toggleBaseMap()"
      (legendToggle)="toggleLegend()">
    </app-map-controls>

    <!-- Layer List Panel -->
    <div
      [class.hidden]="!showLayerList"
      class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-4 z-50 max-h-[70vh] overflow-auto"
      style="min-width: 400px; max-width: 600px;">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-gray-800">الطبقات</h3>
        <button
          (click)="toggleLayerList()"
          class="text-gray-600 hover:text-gray-800 text-xl">&times;</button>
      </div>
      <div id="layerListDiv"></div>
    </div>

    <!-- BaseMap Panel -->
    <div
      [class.hidden]="!showBaseMap"
      class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-4 z-50 max-h-[70vh] overflow-auto"
      style="min-width: 400px; max-width: 600px;">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-gray-800">خرائط الأساس</h3>
        <button
          (click)="toggleBaseMap()"
          class="text-gray-600 hover:text-gray-800 text-xl">&times;</button>
      </div>
      <div id="baseMapDiv"></div>
    </div>

    <!-- Legend Panel -->
    <div
      [class.hidden]="!showLegend"
      class="absolute bottom-4 left-4 bg-white rounded-lg shadow-xl p-4 z-50 max-h-[60%] overflow-auto"
      style="min-width: 250px; max-width: 400px;">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-gray-800">وسيلة الإيضاح</h3>
        <button
          (click)="toggleLegend()"
          class="text-gray-600 hover:text-gray-800 text-xl">&times;</button>
      </div>
      <div id="legendContainer"></div>
    </div>
  </div>
</div>

